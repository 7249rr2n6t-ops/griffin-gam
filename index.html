using UnityEngine;

public class ChaosHouseGame : MonoBehaviour
{
    CharacterController controller;
    Camera cam;

    Vector3 velocity;
    float gravity = -28f;
    float speed = 4f;
    float jumpForce = 8f;

    float shakeTime;

    void Start()
    {
        // Player
        GameObject player = GameObject.CreatePrimitive(PrimitiveType.Capsule);
        player.name = "BennyBroadbelly";
        player.transform.position = new Vector3(0, 1, -6);
        controller = player.AddComponent<CharacterController>();
        controller.height = 1.7f;
        controller.radius = 0.6f;

        cam = Camera.main;
        cam.transform.SetParent(player.transform);
        cam.transform.localPosition = new Vector3(0, 1.4f, -3);
        cam.fieldOfView = 65;

        BuildHouse();
    }

    void Update()
    {
        float x = Input.GetAxis("Horizontal");
        float z = Input.GetAxis("Vertical");

        Vector3 move = transform.right * x + transform.forward * z;
        controller.Move(move * speed * Time.deltaTime);

        if (controller.isGrounded)
        {
            velocity.y = -2f;
            if (Input.GetButtonDown("Jump"))
                velocity.y = jumpForce;
        }

        velocity.y += gravity * Time.deltaTime;
        controller.Move(velocity * Time.deltaTime);

        if (shakeTime > 0)
        {
            cam.transform.localPosition += Random.insideUnitSphere * 0.15f;
            shakeTime -= Time.deltaTime;
        }
    }

    void BuildHouse()
    {
        // Meg Room
        MakeFloor(new Vector3(0,0,-6), new Vector3(10,1,10), false);

        // Baby obstacle in doorway
        GameObject baby = GameObject.CreatePrimitive(PrimitiveType.Cube);
        baby.transform.position = new Vector3(0,0.3f,-1);
        baby.transform.localScale = new Vector3(3,0.6f,1.2f);
        baby.AddComponent<ChaosObstacle>();

        // Hallway (slippery socks)
        MakeFloor(new Vector3(0,0,6), new Vector3(4,1,12), true);

        // Stairs (betrayal steps)
        for (int i = 0; i < 7; i++)
        {
            GameObject step = GameObject.CreatePrimitive(PrimitiveType.Cube);
            step.transform.position = new Vector3(0, i * 0.3f, 13 + i);
            step.transform.localScale = new Vector3(4,0.3f,1);
            step.AddComponent<BetrayStep>();
        }

        // Living room bounce couch
        GameObject couch = GameObject.CreatePrimitive(PrimitiveType.Cube);
        couch.transform.position = new Vector3(0,1.2f,24);
        couch.transform.localScale = new Vector3(6,1,3);
        couch.AddComponent<BouncePad>();
    }

    void MakeFloor(Vector3 pos, Vector3 size, bool slippery)
    {
        GameObject floor = GameObject.CreatePrimitive(PrimitiveType.Cube);
        floor.transform.position = pos;
        floor.transform.localScale = size;
        if (slippery)
            floor.AddComponent<SlipperyFloor>();
    }

    public void ShakeCamera()
    {
        shakeTime = 0.4f;
    }
}

// ===== CHAOS COMPONENTS =====

class ChaosObstacle : MonoBehaviour
{
    void OnCollisionEnter(Collision col)
    {
        if (col.gameObject.name == "BennyBroadbelly")
        {
            col.transform.position = new Vector3(0, 1, -6);
            Camera.main.GetComponentInParent<ChaosHouseGame>().ShakeCamera();
        }
    }
}

class SlipperyFloor : MonoBehaviour
{
    void OnCollisionStay(Collision col)
    {
        col.transform.position += col.transform.forward * Time.deltaTime * 2f;
    }
}

class BetrayStep : MonoBehaviour
{
    bool triggered;

    void OnCollisionEnter(Collision col)
    {
        if (!triggered && Random.value > 0.5f)
        {
            triggered = true;
            transform.Rotate(30, 0, 0);
        }
    }
}

class BouncePad : MonoBehaviour
{
    void OnCollisionEnter(Collision col)
    {
        CharacterController cc = col.gameObject.GetComponent<CharacterController>();
        if (cc != null)
        {
            col.transform.position += Vector3.up * 3f;
        }
    }
}